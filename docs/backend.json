{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the system with role-based access control.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "User's first name."
        },
        "lastName": {
          "type": "string",
          "description": "User's last name."
        },
        "role": {
          "type": "string",
          "description": "User's role (Admin, Control Owner, Auditor, Viewer)."
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates whether the user account is active."
        },
        "lastLogin": {
          "type": "string",
          "description": "Timestamp of the user's last login.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName",
        "role",
        "isActive"
      ]
    },
    "Asset": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Asset",
      "type": "object",
      "description": "Represents an IT asset within the organization.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Asset entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the asset."
        },
        "type": {
          "type": "string",
          "description": "Type of asset (e.g., Server, Application, Database)."
        },
        "ownerId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Asset)"
        },
        "classification": {
          "type": "string",
          "description": "Classification of the asset (e.g., Critical, Confidential)."
        },
        "lifecycleStatus": {
          "type": "string",
          "description": "Lifecycle status of the asset."
        },
        "tags": {
          "type": "array",
          "description": "Keywords or tags associated with this asset",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "type",
        "ownerId",
        "classification",
        "lifecycleStatus"
      ]
    },
    "Control": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Control",
      "type": "object",
      "description": "Represents a security or IT control.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Control entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the control."
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the control."
        },
        "type": {
          "type": "string",
          "description": "Type of control (Preventive, Detective, Corrective)."
        },
        "category": {
          "type": "string",
          "description": "Category of the control."
        },
        "frameworkMapping": {
          "type": "string",
          "description": "Compliance framework mapping (e.g., ISO 27001, NIST)."
        },
        "testingFrequency": {
          "type": "string",
          "description": "Frequency for testing the control (e.g., Monthly, Quarterly)."
        },
        "ownerId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Control)"
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "type",
        "category",
        "frameworkMapping",
        "testingFrequency",
        "ownerId"
      ]
    },
    "ControlImplementation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ControlImplementation",
      "type": "object",
      "description": "Represents the implementation status and evidence for a control.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ControlImplementation entity."
        },
        "controlId": {
          "type": "string",
          "description": "Reference to Control. (Relationship: Control 1:N ControlImplementation)"
        },
        "assetId": {
          "type": "string",
          "description": "Reference to Asset. (Relationship: Asset 1:N ControlImplementation)"
        },
        "status": {
          "type": "string",
          "description": "Implementation status (Not Implemented, In Progress, Implemented, Verified)."
        },
        "evidenceLink": {
          "type": "string",
          "description": "Link to evidence of control implementation.",
          "format": "uri"
        },
        "evidenceDescription": {
          "type": "string",
          "description": "Description of the uploaded evidence."
        },
        "lastUpdated": {
          "type": "string",
          "description": "Timestamp of the last update to the control implementation.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "controlId",
        "assetId",
        "status"
      ]
    },
    "Framework": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Framework",
      "type": "object",
      "description": "Represents a compliance framework (e.g., ISO 27001, NIST).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Framework entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the framework."
        },
        "description": {
          "type": "string",
          "description": "Description of the framework."
        }
      },
      "required": [
        "id",
        "name",
        "description"
      ]
    },
    "ControlFrameworkMapping": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ControlFrameworkMapping",
      "type": "object",
      "description": "Links a control to a specific framework.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ControlFrameworkMapping entity."
        },
        "controlId": {
          "type": "string",
          "description": "Reference to Control. (Relationship: Control 1:N ControlFrameworkMapping)"
        },
        "frameworkId": {
          "type": "string",
          "description": "Reference to Framework. (Relationship: Framework 1:N ControlFrameworkMapping)"
        }
      },
      "required": [
        "id",
        "controlId",
        "frameworkId"
      ]
    },
    "AuditLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AuditLog",
      "type": "object",
      "description": "Represents an audit log entry for tracking changes.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AuditLog entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N AuditLog)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of the audit event.",
          "format": "date-time"
        },
        "entityType": {
          "type": "string",
          "description": "Type of entity that was modified (e.g., Asset, Control)."
        },
        "entityId": {
          "type": "string",
          "description": "ID of the entity that was modified."
        },
        "action": {
          "type": "string",
          "description": "Action performed (e.g., Created, Updated, Deleted)."
        },
        "details": {
          "type": "string",
          "description": "Detailed information about the changes made."
        }
      },
      "required": [
        "id",
        "userId",
        "timestamp",
        "entityType",
        "entityId",
        "action"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. User documents are secured via path-based ownership. Only the user (or an admin) can read/write their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/assets/{assetId}",
        "definition": {
          "entityName": "Asset",
          "schema": {
            "$ref": "#/backend/entities/Asset"
          },
          "description": "Stores IT assets owned by a specific user. Includes denormalized 'ownerId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "assetId",
              "description": "The unique identifier for the asset."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/controls/{controlId}",
        "definition": {
          "entityName": "Control",
          "schema": {
            "$ref": "#/backend/entities/Control"
          },
          "description": "Stores controls owned by a specific user. Includes denormalized 'ownerId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "controlId",
              "description": "The unique identifier for the control."
            }
          ]
        }
      },
      {
        "path": "/controlImplementations/{controlImplementationId}",
        "definition": {
          "entityName": "ControlImplementation",
          "schema": {
            "$ref": "#/backend/entities/ControlImplementation"
          },
          "description": "Stores control implementations. No ownership implied, so flat collection is appropriate.",
          "params": [
            {
              "name": "controlImplementationId",
              "description": "The unique identifier for the control implementation."
            }
          ]
        }
      },
      {
        "path": "/frameworks/{frameworkId}",
        "definition": {
          "entityName": "Framework",
          "schema": {
            "$ref": "#/backend/entities/Framework"
          },
          "description": "Stores compliance frameworks. No ownership implied, so flat collection is appropriate.",
          "params": [
            {
              "name": "frameworkId",
              "description": "The unique identifier for the framework."
            }
          ]
        }
      },
      {
        "path": "/controlFrameworkMappings/{controlFrameworkMappingId}",
        "definition": {
          "entityName": "ControlFrameworkMapping",
          "schema": {
            "$ref": "#/backend/entities/ControlFrameworkMapping"
          },
          "description": "Stores the many-to-many relationships between controls and frameworks. No ownership implied, so flat collection is appropriate.",
          "params": [
            {
              "name": "controlFrameworkMappingId",
              "description": "The unique identifier for the control framework mapping."
            }
          ]
        }
      },
      {
        "path": "/auditLogs/{auditLogId}",
        "definition": {
          "entityName": "AuditLog",
          "schema": {
            "$ref": "#/backend/entities/AuditLog"
          },
          "description": "Stores audit log entries. No ownership implied, so flat collection is appropriate.",
          "params": [
            {
              "name": "auditLogId",
              "description": "The unique identifier for the audit log."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the ControlSage application's core features, including user management, asset management, control management, evidence tracking, and risk/compliance reporting. The design prioritizes authorization independence, clarity, and scalability. Path-based ownership is used for user-owned data, and denormalization is used to avoid `get()` calls in security rules.\n\n**Authorization Independence:** The structure denormalizes authorization data to avoid hierarchical dependencies. For example, the `Asset` and `Control` documents both include the `ownerId`, which allows security rules to validate ownership without needing to fetch the user document. This ensures that security checks are atomic and efficient. For collaborative scenarios like sharing access to an Asset, a membership map (`members`) would be denormalized to ensure Authorization Independence.\n\n**Structural Segregation:** Each collection is designed to hold documents with similar access control requirements. For example, user data is stored in `/users/{userId}`, ensuring that all documents in this collection have the same ownership-based access control.\n\n**Access Modeling:** The structure uses path-based ownership (`/users/{userId}/assets/{assetId}`) for entities that are owned by a user. This makes it easy to write security rules that enforce ownership. For collaborative scenarios, a membership map is used (though not explicitly required by the current entity definitions).\n\n**QAPs (Rules are not Filters):** The structure supports secure `list` operations by ensuring that each collection contains documents with homogeneous security requirements. For example, listing assets under `/users/{userId}/assets` is secure because the rules can easily filter based on the `userId` path parameter, ensuring that only the assets owned by the user are returned. The segregation into user-specific subcollections (`/users/{userId}/assets`) enables QAPs by scoping queries to data accessible by the authenticated user.\n\n**Invariants:** The structure supports data integrity through clear ownership (e.g., `ownerId` in `Asset` and `Control`) and the use of timestamps (e.g., `lastUpdated` in `ControlImplementation`)."
  }
}